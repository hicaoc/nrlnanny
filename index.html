<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>WAV æ–‡ä»¶æ’­æ”¾å™¨ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        ul { list-style: none; padding: 0; }
        li { margin: 10px 0; padding: 8px; border-bottom: 1px solid #eee; }
        audio { width: 100%; }
        .back-btn {
            display: inline-block;
            margin: 10px 0;
            padding: 6px 12px;
            background: #007cba;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .back-btn:hover { background: #005a87; }
    </style>
</head>
<body>
    <h1>å½•éŸ³æ–‡ä»¶æ’­æ”¾å™¨ï¼ˆæœ€æ–°åœ¨å‰ï¼‰</h1>
    <div id="content">
        <p>åŠ è½½ä¸­...</p>
    </div>

    <script>
        const baseDir = '/filejson/'; // Nginx location è·¯å¾„
        let currentPath = null;

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // âœ… æ ¸å¿ƒï¼šæŒ‰ mtime å€’åºæ’åº
        function sortByMtimeDescending(files) {
            return files.sort((a, b) => {
                const timeA = new Date(a.mtime).getTime();
                const timeB = new Date(b.mtime).getTime();
                return timeB - timeA; // æœ€æ–°åœ¨å‰
            });
        }

        function loadDirectory(path) {
            const url = path + '?json';

            fetch(url)
                .then(res => res.json())
                .then(files => {
                    const content = document.getElementById('content');
                    content.innerHTML = '';

                    // å¦‚æœä¸æ˜¯æ ¹ç›®å½•ï¼Œæ˜¾ç¤ºâ€œè¿”å›â€æŒ‰é’®
                    if (path !== baseDir) {
                        const backBtn = document.createElement('a');
                        backBtn.href = '#';
                        backBtn.textContent = 'â† è¿”å›æ—¥æœŸåˆ—è¡¨';
                        backBtn.className = 'back-btn';
                        backBtn.onclick = (e) => {
                            e.preventDefault();
                            loadDateList();
                        };
                        content.appendChild(backBtn);
                        content.appendChild(document.createElement('br'));
                    }

                    // âœ… ç¬¬ä¸€æ­¥ï¼šå…ˆæŒ‰ mtime å€’åºæ’åºæ‰€æœ‰æ¡ç›®
                    const sortedFiles = sortByMtimeDescending(files);

                    const list = document.createElement('ul');

                    // åŒºåˆ†å¤„ç†ï¼šæ ¹ç›®å½• vs å­ç›®å½•
                    const isRoot = (path === baseDir);

                    sortedFiles.forEach(file => {
                        const li = document.createElement('li');

                        if (file.type === 'directory' && isRoot) {
                            // âœ… åªåœ¨æ ¹ç›®å½•æ˜¾ç¤ºæ—¥æœŸç›®å½•ï¼ˆä¸”å·²æŒ‰ mtime å€’åºï¼‰
                            const dateMatch = file.name.match(/^(\d{4}-\d{2}-\d{2})$/);
                            if (dateMatch) {
                                const dirName = file.name + '/';
                                const encodedDir = encodeURIComponent(file.name) + '/';
                                const dateStr = new Date(file.mtime).toLocaleDateString();

                                li.innerHTML = `
                                    <div>
                                        <strong>
                                            <a href="#" onclick="event.preventDefault(); loadDirectory('${path + encodedDir}');">
                                                ğŸ“ ${dirName}
                                            </a>
                                        </strong>
                                    </div>
                                    <div style="color:#666;font-size:0.9em;">æ›´æ–°äº: ${dateStr}</div>
                                `;
                                list.appendChild(li);
                            }
                        }
                        else if (file.type === 'file') {
                            // æ˜¯æ–‡ä»¶ï¼ˆJSON ä¸­æ²¡æœ‰ type çš„å°±æ˜¯æ–‡ä»¶ï¼‰
                            if (file.name.toLowerCase().endsWith('.wav')) {
                                const date = new Date(file.mtime).toLocaleTimeString();
                                const size = formatSize(file.size);

                                li.innerHTML = `
                                    <div><strong>${file.name}</strong> (${size})</div>
                                    <div style="color:#666;font-size:0.9em;">å½•åˆ¶æ—¶é—´: ${date}</div>
                                    <audio controls preload="none">
                                        <source src="${path + file.name}" type="audio/wav">
                                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ audio å…ƒç´ ã€‚
                                    </audio>
                                `;
                                list.appendChild(li);
                            }
                        }
                    });

                    if (list.children.length === 0) {
                        const empty = document.createElement('p');
                        empty.textContent = 'æ­¤ç›®å½•ä¸ºç©ºã€‚';
                        content.appendChild(empty);
                    } else {
                        content.appendChild(list);
                    }
                })
                .catch(err => {
                    console.error('åŠ è½½å¤±è´¥:', err);
                    document.getElementById('content').innerHTML = `<p>é”™è¯¯: æ— æ³•åŠ è½½ç›®å½• "${path}"</p>`;
                });
        }

        // åŠ è½½æ ¹ç›®å½•ï¼ˆå³æ—¥æœŸåˆ—è¡¨ï¼‰
        function loadDateList() {
            currentPath = null;
            loadDirectory(baseDir);
        }

        // åˆå§‹åŒ–
        loadDateList();
    </script>
</body>
</html>